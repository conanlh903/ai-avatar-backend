import express from "express";
import fetch from "node-fetch";
import cors from "cors";
import dotenv from "dotenv";

dotenv.config();

const app = express();
app.use(cors());
app.use(express.json());

// å¥åº·æ£€æŸ¥æ¥å£
app.get("/", (req, res) => {
  res.send("âœ… AI Avatar backend is running");
});

// AIå¤´åƒç”Ÿæˆæ¥å£
app.post("/generate", async (req, res) => {
  const { prompt } = req.body;
  if (!prompt) {
    return res.status(400).json({ error: "Missing prompt" });
  }

  try {
    // è°ƒç”¨ Replicate åˆ›å»ºé¢„æµ‹ä»»åŠ¡
    const createResp = await fetch("https://api.replicate.com/v1/predictions", {
      method: "POST",
      headers: {
        "Authorization": `Token ${process.env.REPLICATE_API_KEY}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        // å¦‚æœä½ æƒ³ç”¨ flux æ¨¡å‹ï¼š
        model: "black-forest-labs/flux-1.1-pro",
        input: { prompt },
      }),
    });

    const prediction = await createResp.json();

    // æ£€æŸ¥æ˜¯å¦æŠ¥é”™
    if (prediction.error) {
      return res.status(500).json({ error: prediction.error });
    }

    // è½®è¯¢è·å–ç»“æœï¼ˆReplicate ç”Ÿæˆæœ‰å»¶è¿Ÿï¼‰
    let status = prediction.status;
    let result = null;

    while (status !== "succeeded" && status !== "failed") {
      await new Promise((r) => setTimeout(r, 2000));
      const getResp = await fetch(`https://api.replicate.com/v1/predictions/${prediction.id}`, {
        headers: { "Authorization": `Token ${process.env.REPLICATE_API_KEY}` },
      });
      const updated = await getResp.json();
      status = updated.status;
      if (status === "succeeded") result = updated.output;
    }

    if (status === "succeeded" && result && result.length > 0) {
      res.json({ image: result[0] });
    } else {
      res.status(500).json({
        error: "Generation failed or no output returned",
        details: prediction,
      });
    }
  } catch (error) {
    console.error(error);
    res.status(500).json({ error: "Generation failed", details: error.message });
  }
});

// å¯åŠ¨æœåŠ¡å™¨
app.listen(3000, () => console.log("ğŸš€ API Server running on port 3000"));